### “一点測定マップ”を → “広域モデル”へ拡張する 3 つの実践ルート

| ルート                            | 仕組み (概要)                                                                                                                                      | 集める補正パラメータ                                                                                       | 利点 / 留意点                                                                          |
| ------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------- |
| **A. マルチポイント 逐次 EKF（オフライン蓄積）** | 各回転数 × DC 電圧のテストランを回し、ログ再生モードで EKF を後付け実行。<br>走行区間ごとに “モデル誤差係数” Δφ, Δψ<sub>f</sub>, ΔL<sub>d,q</sub> などを収束値として抽出し LUT に追記。                    | - Δφ<sub>d</sub>, Δφ<sub>q</sub><br>- Δψ<sub>f</sub>, ΔR<sub>s</sub><br>- 場合により ΔL<sub>d,q</sub> | **測定コスト小** (定常点しか必要) / バッチ後処理なので安定<br>→ 速度 ω, V<sub>dc</sub>, 温度 T をキーに 5D LUT 構築 |
| **B. デュアル EKF（オンライン学習）**       | 1 個目 EKF で状態 (φ) を推定、2 個目で「モデル係数」をスローペースで推定。<br>テストベンチを回しっぱなしにして、連続軌道上から係数を蓄積。                                                                | - 係数ベクトル **θ(ω,V<sub>dc</sub>,T)** を時変状態として推定                                                    | **動的点も利用可**。実機運転中でも常時学習 ⇒ 品質が温度/脱磁に追従。ただし安定性解析が必須                                 |
| **C. 統計／機械学習ベース補正**            | ルート A/B で得た離散補正データを<br> • ガウス過程 (GP) 回帰<br> • ラディアル基底 NN<br> • 多変量スプライン などで**連続関数化**。<br>コントローラ側では base マップ＋補正関数(ω,V<sub>dc</sub>,T) を合成して使用。 | 同上                                                                                               | 外挿が滑らか・連続 ⇒ MTPA/FW テーブル更新が簡単。ただし外れ領域で不確実性評価 (σ) を持たせる工夫が要る                       |

---

## 具体的ステップ（ルート A を例に）

1. **計測計画**

   * $ω =$ {500, 1000, 2000, 4000 rpm}
   * $V_{dc} =$ {400, 500, 600 V}
   * 温度ステップ {25 °C, 60 °C, 90 °C}
     など 3 × 4 × 3 の定常点で **Id–Iq スイープ** し電流・電圧ログ取得。

2. **オフライン EKF**

   ```python
   for log in all_logs:
       ekf.reset()              # 名目マップで初期化
       for k in log:            # log: (vd,vq,id,iq,ω)
           ekf.predict(u=[vd,vq,ω])
           ekf.update(z=[id,iq])
       θ_corr = ekf.x[Δφ,Δψf,ΔRs]   # 収束値
       store(theta=θ_corr, ω=ω_set, Vdc=V_set, T=temp)
   ```

3. **補正 LUT 生成**

   * キー: $(ω,\,V_{dc},\,T)$
   * 値: 収束した補正係数ベクトル θ
   * 補間: 線形 or バリスティック (必要なら外挿に GP)。

4. **運転時適用**

   ```python
   θ = lut.interpolate(ω_now, Vdc_now, T_now)
   φ_nom = base_map(Id,Iq)
   φ_corr = φ_nom + Δφ(θ) + Δψf(θ)
   ```

---

## 役立つテクニック

| テクニック            | 目的                                                        |
| ---------------- | --------------------------------------------------------- |
| **完全逆スイープ不要化**   | Δ係数が小さい前提で *small-signal EKF* にして、短時間のランダムパルスでも収束可        |
| **Q/R 自動チューニング** | 各動作点で “調整しないと収束しない” 場合、Covariance-matching 法で最適 Q/R を同時推定 |
| **データ同化 (EnKF)** | 非線形・多パラメータなら Ensemble KF で尤度を保ちながら多面探索                    |

---

## まとめ

* **はい、可能** – EKF で各動作点の“モデル誤差”を推定し、
  LUT あるいは回帰モデルに集約すれば **広域フラックスマップ** が構築できる。
* 最初は **オフライン再生 + バッチ蓄積 (ルート A)** が安全・シンプル。
* オンライン適応や GP 補間を導入すると、温度や脱磁劣化にも強い汎化マップとなる。
