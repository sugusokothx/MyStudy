## 1. エネルギー関数 $W(i_d,i_q)$ とは？

内挿・平滑の段階で **“φd/φq マップを別々にフィットすると、
混合導関数が一致しない”**（= 物理的にあり得ない）ことがあります。
これを根本から解決する作法が

$$
\boxed{\; 
  W(i_d,i_q)\;\; \text{を直接フィットし、}
  \;\; 
  \begin{cases}
     \phi_d = \dfrac{\partial W}{\partial i_d} \\[4pt]
     \phi_q = \dfrac{\partial W}{\partial i_q}
  \end{cases}
\;}
$$

という **エネルギー関数フィット**です。
$W$ を 1 つ用意すれば、**クロス導関数の対称性**

$$
M(i_d,i_q) \;=\; 
\frac{\partial \phi_d}{\partial i_q} 
\;=\;
\frac{\partial \phi_q}{\partial i_d}
\tag{★}
$$

（Schwarz の定理：混合 2 階偏微分の交換可能性）が
“自動的に” 保たれます。

---

## 2. 物理的な意味 ─ なぜ $M$ は重要か？

| 項目                | 関連式                                                         | インプリケーション                   |
| ----------------- | ----------------------------------------------------------- | --------------------------- |
| **磁気エネルギー**       | $W = \tfrac12 \bigl( \phi_d i_d + \phi_q i_q \bigr)$        | $M$ が不整合だと **エネルギー非保存** を示唆 |
| **トルク**           | $T_e = \dfrac{3}{2} p \bigl(\phi_d i_q - \phi_q i_d \bigr)$ | φ の整合性が狂うと **トルク計算に発散** が出る |
| **EKF / UKF ヤコビ** | $\partial\phi / \partial i$ 行列に $M$ が入る                     | 解析ヤコビを省いても **数値安定化**        |

> **IPM** では $M\neq0$ が一般的ですが、
> **SPM**（突極性なし）は理想論的に $M=0$。
> いずれにせよ ★ を満たすことで “相互インダクタンスの対称性” が保証されます。

---

## 3. 手順：測定データ → $W$ → $φd,φq,L_d,L_q,M$

### ❶ 基底を決める

多項式なら **総次数 3〜5** が実用的。

$$
W(i_d,i_q)=\sum_{p+q\le n} a_{pq}\,i_d^p i_q^q
$$

### ❷ 偏微分行列を作る

$$
\phi_d = \partial W / \partial i_d, \quad
\phi_q = \partial W / \partial i_q
$$

→ **線形結合**になるので「係数行列 A × a = b」は *最小二乗* で一発。

### ❸ マップ生成

* $\phi_d, \phi_q$：1 階微分
* $L_d = \partial\phi_d/\partial i_d$，
  $L_q = \partial\phi_q/\partial i_q$
* **$M = \partial\phi_d/\partial i_q$**（＝$\partial\phi_q/\partial i_d$）

> **メリット**：すべて解析式なので
>
> * **連続滑らか (C¹)**
> * 任意解像度で再サンプリング自由
> * $L_d, L_q, M$ を追加で測定しなくても得られる

---

## 4. MATLAB コア実装スニペット

```matlab
% --- 測定散在点を読み込み --------------------------------------------
X = [id(:), iq(:)];        % N×2
Y = [phid(:); phiq(:)];    % 2N×1  (縦結合)

% --- 基底行列 (polybasis2d: 前ターンで提供済み) -----------------------
n = 4;                                    % 総次数
[P, dPid, dPiq, d2Pid2, d2Piq2, d2Pidq] = polybasis2d_full(X, n);

%   ※ polybasis2d_full は d²W/∂id∂iq も返す拡張版
%
%    A · a = b   を組む
A = [dPid; dPiq];           % 2N×M
b = Y;

a = A\b;                    % 最小二乗係数

% --- 任意グリッドへ展開 ----------------------------------------------
[ID, IQ] = meshgrid(id_vec, iq_vec);
Xt = [ID(:), IQ(:)];
[~, dWid, dWiq, d2Wid2, d2Wiq2, d2Widq] = polybasis2d_full(Xt, n);

Phi_d = reshape(dWid * a,  size(ID));
Phi_q = reshape(dWiq * a,  size(ID));
Ld    = reshape(d2Wid2 * a, size(ID));
Lq    = reshape(d2Wiq2 * a, size(ID));
M     = reshape(d2Widq * a, size(ID));   % = ∂φd/∂iq = ∂φq/∂id
```

---

## 5. 数値チェック：$M_{\text{LH}} - M_{\text{RH}}$

```matlab
% 数値差分で ∂φq/∂id を計算して比較
[Phi_q_did, ~] = gradient(Phi_q, id_step, iq_step);
err = M - Phi_q_did;
fprintf('max|ΔM| = %.3e\n', max(abs(err(:))));
```

* **1e-10 以下** ならほぼ丸め誤差だけ → ★ が担保された証拠
* 相違が大きければ **次数不足** か **測定誤差・ノイズ大** → 平滑化 or n↑

---

## 6. 実務 Tips

| 目的                  | 推奨 n | 備考                |
| ------------------- | ---- | ----------------- |
| **制御器用ルックアップ**      | 3〜4  | テーブル軽量＋十分滑らか      |
| **学術論文レベルの精度**      | 5〜6  | 過学習注意（正則化 λ を入れる） |
| **高速 ECU 実装（整数演算）** | 2〜3  | 係数を固定点に量子化        |

* **正則化**：`a = (A'*A + λI)\(A'*b)` で λ = 1e-6〜1e-4
  → 測定ノイズが多いときに有効
* **偶関数／奇関数制約**：多項式の **次数選択** で自然に反映
  （例：φd 偶 → $p+q$ が偶数のみ など）

---

### まとめ

* **エネルギー関数 $W$** を直接フィットすると

  * 物理整合性（★）が保証される
  * Ld/Lq/M マップを一括で得られる
* 実装は「基底行列＋最小二乗」だけなのでシンプル。
* フィット後は **$M$ が滑らかか**、**混合導関数が一致しているか** を必ず数値確認しましょう。

このアプローチを採れば、EKF や MTPA 計算で “微分のギクシャク” に悩まされることが激減します。
さらなる詳細（正則化、基底変更、Python 版コードなど）が必要でしたら、遠慮なくお知らせください！
