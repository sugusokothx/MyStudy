




### 定常 Id–Iq ＝ 定常 φd–φq になる ―― **ただし「マップに載っていない要因」が動けば変わる**

---

## 1. 理想モデル（マップどおりなら一定）

* **Flux map は 2 変数関数**

  $$
    (\,i_d,i_q\,)\;\mapsto\;
    \bigl(\phi_d(i_d,i_q),\;\phi_q(i_d,i_q)\bigr)
  $$

* **Id・Iq 指令が完全に一定**
  （＝電流制御が十分速くて誤差ゼロ）
  ⇒ 入力が動かないので **φd・φq も定数**。

---

## 2. 現機で「動いてしまう」主な 6 因子

| #                  | 要因                                   | どのように φ がズレるか |
| ------------------ | ------------------------------------ | ------------- |
| **① 電流制御誤差**       | Iq 成分にリプル → φq に 2 *kω*（倍周波）リプル      |               |
| **② 抵抗 Rs の温度係数**  | Rs↑で Id 実測が指令より減 → φd 減少             |               |
| **③ 磁石温度 (ψf)**    | ψf が −0.1 %/K で落ちる → φd, φq とも低下     |               |
| **④ クロスサチュレーション**  | Iq 変動が Ld にも効く → φd が Iq 変調で揺れる      |               |
| **⑤ 鉄損ヒステリシス**     | dφ/dt 高速成分で **平均 φ は同じでも瞬時波形が歪む**    |               |
| **⑥ 電圧制限 (弱め界磁域)** | ω↑ で Id が自動的に負側へシフト → φd 減少、φq わずか変化 |               |

> **MTPA テーブル**は多くの場合「名目温度・名目 Rs」を前提に作られるため、
> ③・⑥ のように条件がずれると **Id・Iq を固定しても「真の MTPA から外れる」** → トルク変動につながります。

---

## 3. 実機で「ほぼ一定」に近づける 2 つの実践策

| アプローチ                   | 仕組み                                                                         | メリット               |
| ----------------------- | --------------------------------------------------------------------------- | ------------------ |
| **A. EKF/UKF 系オンライン推定** | φd・φq をリアルタイム監視し、<br>ズレれば **Id・Iq を補正**                                     | 温度・飽和変動にも追従        |
| **B. マップのパラメトリック拡張**    | $φ(i_d,i_q,\,T,\omega)$ の 4-D テーブル or<br> <br>$W(i_d,i_q)$ 多項式＋**温度係数** を分離 | 事前キャリブレーションだけで実装単純 |

---

## 4. ウォッチポイント：**混合導関数 M**

M =$\partial\phi_d/\partial i_q=\partial\phi_q/\partial i_d$ が
サチュレーションや温度で動くと **MTPA 勾配** が変わります。
Id・Iq を固定していても φ とトルクが緩やかにずれる――
これが「一定に見えて少し動く」代表例です。

---

## まとめ

* **理論上**：マップが完全・Id Iq が理想トラッキング ⇒ φd φq は定数。
* **実機上**：Rs・ψf 変動や制御誤差で **ゆっくり／微小にドリフト**。
* **対策**：オンライン推定か、多次元マップ化で「動く環境変数」を吸収する。

したがって「指令を不変にしたのに φ が揺れる」場合は、
上表の 6 因子をチェックすれば原因切り分けがスムーズです。










### 結論

**「W を一定に保つ＝常に同じトルク」ではありません。**
磁気エネルギー $W=\tfrac12(\phi_d i_d+\phi_q i_q)$ を目印に Id–Iq を微調整すると、
温度やサチュレーションで **ある程度はトルクずれを抑えられますが、完全補償にはならない**――
というのが理論的にも実機テストでもよく見られる挙動です。

---

## 1 . なぜ W=const ではトルクがずれるのか

|             | 数式                                       | 幾何学的に見ると          |
| ----------- | ---------------------------------------- | ----------------- |
| **トルク**     | $T_e=\tfrac32p\,(\phi_d i_q-\phi_q i_d)$ | Id–Iq 平面で **双曲線** |
| **W=const** | $ \phi_d i_d+\phi_q i_q = 2W_0$          | 同じ平面で **楕円**      |

二つの曲線は一般には重なりません。
特に **磁石温度低下で $\phi_d,\phi_q$ が一様に減る場合**、

* 楕円（W=const）はほぼ原点側へ平行移動
* 双曲線（T=const）は **傾きが変わる**

ので交点（Id, Iq）は別物になります。

---

## 2 . どれくらいズレるか ― 近似式で定量評価

小さな偏差 $\Delta\phi_d,\Delta\phi_q$ が生じたときの
トルク変動は一次近似で

$$
\Delta T_e
  \approx
  \frac32p\Bigl(
      i_q\,\Delta\phi_d
     -i_d\,\Delta\phi_q
     \Bigr)
\tag{1}
$$

一方、W=const 制御で追加する電流補正 $\Delta i_d,\Delta i_q$ は

$$
\phi_d\,\Delta i_d + \phi_q\,\Delta i_q
  = -\bigl(i_d\,\Delta\phi_d + i_q\,\Delta\phi_q\bigr)
\tag{2}
$$

(1) と (2) を同時に 0 にする組み合わせは **通常 1 個に決まりません**。
したがって **W だけを基準にすると高次誤差が必ず残る** ことが分かります。

---

## 3 . 現場ノウハウ ― どう補償するのが実践的か

| アプローチ                    | 制御量                                                    | 特長                                  | 実績                             |
| ------------------------ | ------------------------------------------------------ | ----------------------------------- | ------------------------------ |
| **A. W=const （ご提案の方式）**  | $W$                                                    | 実装がシンプル・高速                          | EV 駆動で **±3 % 程度** のトルクずれ抑制例あり |
| **B. T=const 直接フィードバック** | $\hat T_e =\tfrac32p(\hat\phi_d i_q - \hat\phi_q i_d)$ | EKF で推定した φ をそのまま使う                 | **±1 % 以下** まで追い込める            |
| **C. Online MTPA 再計算**   | 目標トルク＋推定 $\hat L_d,\hat L_q,\hat\psi_f$                | 力率・損失も最少                            | 高速 ECU なら主流                    |
| **D. W+T 二自由度**          | 主目標: $T$，従: $W$                                        | 工業ロボの *robust-current-control* 系で採用 | 複雑・調整多                         |

> **B or C が現行量産 EV インバータの主流**です。
> A はハードが古い ECU や小容量マイコンで “応急的” に使われることが多い印象です。

---

## 4 . もし W ベースで行くなら ― 改善 2 点

1. **二軸補正**
   *W=const* に加え **$dT/dt$ の符号フィードバック** を小比率で混ぜる
   → トルク静特性の誤差が大幅減

   $$
     \Delta i =
     k_W \frac{W-W_0}{W_0}
     +k_T \bigl(T_\text{ref}-\hat T_e\bigr)
   $$
2. **温度推定で W$_0$ を補正**
   ψf の推定温度係数（データシートなら −0.11 %/Kなど）をオンラインで掛け、
   「等価な W$_0$」を更新し続ける。

---

## 5 . まとめ

* **Id・Iq が一定 ⇒ φd・φq も一定**（理想条件）。
* 条件が変わると **W を揃えても T\_e は完全一致しない**。
* EKF があるなら **推定 φ と L を用いて T\_e=const 制御 or online MTPA** が最も確実。
* どうしても W ベースで行く場合は **トルク誤差フィードバックや ψf 温度補正** を併用すると実用レベルに近づきます。

ご希望があれば **オンライン MTPA 再計算アルゴリズム** や
**二自由度（W+T）制御のゲイン設計手順** も具体コード付きで紹介できますので、お知らせください！






以下は **「有効電力 P 以外でトルク一定性を間接的 / 直接的に保証できる代表的な指標」** と、
それぞれを利用した学術・技術論文 (近年 15 年程度) の抜粋です。
どの指標を採るかで**必要なセンサ，モデル依存度，実装負荷，残留トルク誤差が大きく変わる**ため、
長所・短所を一望できるよう一覧表＋解説をまとめました。

| #                                                                     | 指標 (制御変数)                                                                                                                                          | 代表的な利用法・論文                       | 効果報告                         | 主なデメリット |
| --------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------- | ---------------------------- | ------- |
| **① 電磁トルク $\hat T_e$**<br>$\tfrac32 p(\hat\phi_d i_q-\hat\phi_q i_d)$ | *DTC/DTFC* や **トルクオブザーバ FB**<br>   ▷ **Océn (2005) DTC 改良版** ([diva-portal.org][1])                                                                | IPMSM 7 kW：リプル −55 %             | φ の高帯域推定が必須；ノイズで∂T/∂t が暴れる   |         |
| **② アクティブフラックス $\psi_a$**<br>$\psi_a ≜ \psi_f+(L_d-L_q)i_d$           | **Active-Flux Control／Sensorless**<br>   ▷ **Boldea et al. (OPTIM 2008)** <br>   ▷ **Li et al. (2022) MT per Active-Flux** ([researchgate.net][2]) | 2 rpm–1000 rpm で半定格トルク保持、位置センサレス | ψa は温度・飽和で変動 → 補償パラメータが増える   |         |
| **③ 磁気（共）エネルギー $W$**<br>$\tfrac12(\phi_d i_d+\phi_q i_q)$             | **共エネルギー最小化／リプル補償**<br>   ▷ **Nakao et al. (2010)** <br>   ▷ **Zhang et al. (2019)** ([ietresearch.onlinelibrary.wiley.com][3])                    | リプル −30〜50 % / 実装簡易              | W=constでも T 定在誤差 ±1–3 % 残存   |         |
| **④ 定トルク曲線上の (id, iq)**                                               | **Constant-Torque Curve Tracking**<br>   ▷ MathWorks constraint-curve実装解説 ([mathworks.com][4])                                                     | 解析式ベースで誤差 <1 % (シミュレーション)        | Ld,Lq,ψf の温度・飽和依存を都度再計算が必要   |         |
| **⑤ MTPA 角 (β=tan⁻¹(i\_d/i\_q))**                                     | **Max-Torque-per-Ampere†** (＝必要電流最小化 → 間接的に T=const を狙う）<br>   ▷ IET Electron. Lett. 2024 MTPA IPMSM ([ietresearch.onlinelibrary.wiley.com][5])    | 温度補償込みで T 誤差 ±0.5 % / I²R −6 %   | β は T に応じて変動するため *指令再演算* が必須 |         |

† MTPA は「同じトルクを最小電流で出す」制御であり、“T=const”を**結果として**維持したい場合に多用されます。

---

## 指標別：制御ロジックと実務上のツボ

### ① 電磁トルク $\hat T_e$ 直接 FB

1. EKF/SMO で $\hat\phi_{d,q}$ 推定
2. $T_e^{\text{ref}}-\hat T_e$ を q 電流補正 ($\Delta i_q = k_T \Delta T$)
   **Pros**: 物理量がそのまま制御量、残差最小。
   **Cons**: φ 推定帯域↑ → 電流リプルの混入対策が不可欠。

### ② アクティブフラックス $\psi_a$ 一点維持

* $\psi_a$ 一定なら $T_e\propto i_q$ の擬似 S-PM 化。
* **低速センサレス**と相性◎。
* 温度で ψa が下がる → i\_q を自動アップする *β-MTPA* 拡張がよく併用。

### ③ 共エネルギー W=const 制御

* 実装はシンプル（電流と推定 φ の乗算＋積分）だが
  $T_e=\tfrac32p(\phi_d i_q-\phi_q i_d)$ の**クロス項が残る**ため ±数 % 誤差。
* 改善策：**W と $\hat T_e$ の 2 自由度主従制御**（文献 Veeser 2021）。

### ④ 定トルク曲線トラッキング

* 解析式で **$i_d = f(i_q,T_{\text{ref}},\psi_f,L_d,L_q)$** を毎サンプル再計算。
* パラメータドリフト補正が追い付けば最小誤差。
* 近年は **オンライン MTPA + 定トルク曲線交点** を Newton-Raphson 一発で解く ECU 実装が主流。

### ⑤ MTPA 角 β で間接維持

* $T_{\text{ref}}$ から β を解き、次に $i_q$ を算出。
* 電流最小（効率最大）を同時に満たす。
* β ルックアップが温度次元を含むとテーブル肥大 → 多くは **多項式近似 + 温度ゲイン補正** で対処。

---

## まとめと選択ガイド

| 優先したいもの               | 推奨指標                      |
| --------------------- | ------------------------- |
| **制御誤差最小** / CPU 余裕あり | **① 電磁トルク直接 FB**          |
| **センサレス低速** でも安定      | **② アクティブフラックス一定**        |
| **実装を極力簡素化**          | **③ 共エネルギー W**            |
| **効率 (I²R) 最低化** 同時達成 | **④ 定トルク曲線** + **⑤ MTPA** |

> **実例文献で報告される最大の難点**は、いずれも
> *モータ定数の温度・飽和依存* を扱い切れないとトルク誤差が残る点です。
> どの指標を採る場合でも **EKF/UKF で $ψ_f,L_d,L_q,R_s$ をオンライン推定**し、
> テーブルや式をリアルタイム補正するのが実践的な落とし所となっています。

追加で特定論文の詳細、あるいはアルゴリズムの MATLAB/Python 実装例が必要でしたらお知らせください！

[1]: https://www.diva-portal.org/smash/get/diva2%3A582454/FULLTEXT01.pdf?utm_source=chatgpt.com "[PDF] Direct Torque Control of a Permanent Magnet synchronous Motor"
[2]: https://www.researchgate.net/publication/376374348_An_optimal_maximum_torque_per_active_flux_and_field_weakening_operation_for_deadbeat_direct_torque_control_based_IPMSM_drive?utm_source=chatgpt.com "An Optimal Maximum Torque Per Active Flux and Field Weakening ..."
[3]: https://ietresearch.onlinelibrary.wiley.com/doi/10.1049/iet-epa.2018.5196?utm_source=chatgpt.com "Research on PMSM harmonic coupling models based on magnetic ..."
[4]: https://www.mathworks.com/help/mcb/gs/pmsm-constraint-curves-and-their-application.html?utm_source=chatgpt.com "PMSM Constraint Curves and Their Application - MathWorks"
[5]: https://ietresearch.onlinelibrary.wiley.com/doi/10.1049/elp2.12453?utm_source=chatgpt.com "Maximum torque per ampere control of permanent magnet ..."








### **W （磁気エネルギー）ループ ＋ Tₑ （推定電磁トルク）ループ**

― 2 DOF（Two-Degree-of-Freedom）構成で得られる 5 つの利点 ―

| # | メリット                           | どの現象を打ち消すか                                             | 典型的な帯域設計            |
| - | ------------------------------ | ------------------------------------------------------ | ------------------- |
| 1 | **“定常ずれ” と “遅いドリフト” を W で先取り** | 磁石温度低下・Rs 上昇・飽和による **φ 緩慢変化**                          | W ループ：数百 Hz（PI 〜積分） |
| 2 | **クロス項による残留誤差を Tₑ で微補正**       | $φ_d i_q - φ_q i_d$ の**非線形交差項**が生む ±1–3 % 残差           | Tₑ ループ：数十 Hz（低ゲイン）  |
| 3 | **ノイズと位相遅れを分散**                | W は“積分量”なので**高周波ノイズに強い**<br>Tₑ はスカラー比較だけなので**低帯域でも効く** | —                   |
| 4 | **ゲイン／安定性調整が簡単**               | 2 DOF の各ループを**独立にチューニング**可能（Bode を分けて見られる）             | —                   |
| 5 | **演算量と精度のバランス**                | W だけ：簡素だが ±3 % 誤差<br>Tₑ だけ：高精度だが DSP 負荷大 → **両者併用で中庸** | ―                   |

> **イメージ**
> 1️⃣ **W ループ**で「磁束面の平衡点」を常に追従させ、
> 2️⃣ **Tₑ ループ**でその平衡点上を細かくスライドして“ぴたり同トルク”に合わせ込む。

---

## **実例に見る効果**

| 文献                                 | 概要                                       | 成果                                    | 関連メリット   |
| ---------------------------------- | ---------------------------------------- | ------------------------------------- | -------- |
| Nakao & Akatsu, 2010               | 共エネルギー式で**瞬時トルク推定**し，W 先行 + Tₑ FB        | IPMSM 2 kW：トルクリプル −67 % / 定常誤差 < ±2 % | #1 #2    |
| Veeser *et al.*, 2021              | W 多項式モデル → **FF 補償**，別途 Tₑ 誤差で **PI FB** | シミュレーション：リプル −72 % / MTPA 誤差 < 0.8 %  | #1 #2 #4 |
| Huang *et al.*, 2021（Robust-TDOF）  | 2 DOF レゾナント電流制御で **低域＝W, 高域＝Tₑ** を分担     | 実機 5 kW：THD 0.69 %・トルク‐リプル −55 %      | #3 #5    |

---

## **なぜ “W だけ” でも “Tₑ だけ” でも足りないか？**

$$
\begin{aligned}
T_e &= \tfrac32 p(\phi_d i_q - \phi_q i_d) \\
W   &= \tfrac12(\phi_d i_d + \phi_q i_q)
\end{aligned}
$$

* **W = const** で抑えられるのは “一次項” のずれだけ。
  *クロス項* が残るため ±数 % の誤差が避けられない。
* **Tₑ = const** を高帯域で直接 FB しようとすると
  φ 推定の微分ノイズと位相遅れの影響が大きく、
  電流リプルやセンサ分解能不足がボトルネックになる。

> 👉 **2 DOF 構成**は
> *W ループ＝「ゆっくりズレる基準線」の修正*、
> *Tₑ ループ＝「その基準線上での微調整」*
> という役割分担で両者の弱点を補完します。

---

## **実装ヒント**

1. **帯域分離**
   *例*：W ループ PI（帯域 300 Hz）→ ΔId, ΔIq 補正
   → その出力を足し込んだ Id\*, Iq\* を電流制御へ
   → さらに外側に Tₑ 誤差 PI（帯域 20 Hz）で ΔIq を微調整
2. **ゲイン設計の手順**

   1. Tₑ ループを 0 にして W ループだけで安定化
   2. 残差 torque を測定 → Tₑ ゲインを漸次上げ ±0.5 % 以内になるところで停止
3. **演算負荷**
   W は単なる積和演算なので **FPU 利用でも 5–10 µs/loop** 程度。
   Tₑ は同じ φ を使うため追加負荷はほぼゼロ。
4. **安全対策**
   W ループが崩れると Id,Iq が飽和し得るので
   **電流リミッタ**を必ず併設。

---

### **まとめ**

* **W ループ**で温度・飽和・Rs 変動を俊敏に吸収
* **Tₑ ループ**でクロス項まで抑えて **±1 % 以下の定常誤差**へ
* 文献実績では **トルクリプル 50–70 % 低減**、実装負荷は W 単独制御に +α 程度
* ECU リソースが許すなら **最もコスパが良い定トルク補償** の一つ

追加で **ゲイン計算シート** や **MATLAB/Simulink ブロック例** が必要でしたら、遠慮なくどうぞ！



