## EKF とは何か ― 全体像のおさらい

| 種類                                               | 前提               | 数学的特徴                    | 主な用途                         |
| ------------------------------------------------ | ---------------- | ------------------------ | ---------------------------- |
| **線形カルマンフィルタ (KF)**                              | システムも観測も **線形**  | 解析的に最適（最小分散推定）           | レーダ追跡、経済時系列など                |
| **拡張カルマンフィルタ (EKF)**                             | システム／観測が **非線形** | 毎ステップでヤコビ行列を使い **局所線形化** | ロボティクスの姿勢推定、車両航法、モータ・パラメータ推定 |
| **その他のオブザーバ**<br>（Luenberger，Sliding-Mode，H∞ など） | 線形／非線形どちらも可      | ゲインを解析設計 or 数値最適化        | 制御工学での状態フィードバック，外乱推定         |

---

## 「あとからモデルを追加できる」とは？

### 1. **状態拡張 (State Augmentation)**

EKF では

$$
x_{k+1}=f(x_k,u_k) + w_k,\qquad  
z_k=h(x_k) + v_k
$$

という **非線形状態方程式 $f$・観測方程式 $h$** をコード化しておきます。
新しく推定したい物理量（例：**センサオフセット**、**モータ磁束**, **バッテリ内部抵抗**…）を **追加の状態成分** $x_\text{new}$ にすればよい──

1. $x  \leftarrow [x;\,x_\text{new}]$ に拡張
2. $f,\,h$ を 1 行か 2 行追加
3. 共分散 $P$ と雑音 $Q$ の次元を広げる

これだけで EKF は新しい変数まで同時に推定します。**ゲイン計算は自動的に内部で再実行**されるため、理論上は“フィルタを作り直す”必要がない、という意味で「あとからモデルを追加できる」と言われます。

### 2. **KF や他オブザーバとの比較**

| 観点    | 線形 KF                                    | EKF                         | 典型的なその他オブザーバ        |
| ----- | ---------------------------------------- | --------------------------- | ------------------- |
| 拡張方法  | **線形性を崩さないか**を要確認<br>（例：定数バイアスは線形に追加できる） | **どんな非線形でも追加可**<br>局所線形化で対応 | ゲイン行列を**再設計**するのが普通 |
| 追加工数  | 行列サイズ増 → 数行の行列追加                         | **$f,\,h$ を書き足すだけ**         | 一から安定性解析／ゲイン調整      |
| ノイズ設定 | $Q,R$ を調整                                | 同左                          | 多くは“雑音モデル”自体を持たない   |

---

## EKF が他オブザーバより柔軟な理由

1. **確率論的フレームワーク**
   状態やパラメータを「確率変数」とみなし共分散で信頼度を管理するため、
   *“あとから増えた不確かさ”* を **$Q$ に入れるだけで吸収**できる。

2. **オンライン線形化**
   ヤコビアンさえ計算できればモデル次数が増えても**同じ数式テンプレート**で回る。

3. **ゲインの自己調整**
   観測が増えればイノベーションも自動で増えるので、ゲイン $K_k$ は **代数演算だけで更新**。
   Luenberger や Sliding-Mode のように“人数分”ゲインを手設計し直す手間がない。

---

## 逆に EKF の注意点・限界

| 項目        | 留意点                                                          |
| --------- | ------------------------------------------------------------ |
| **線形化誤差** | 強い非線形／大雑音では発散する可能性。<br>→ UKF や PF などの非線形フィルタを検討。             |
| **計算コスト** | 状態次元 $n$ が増えると $P\in\mathbb R^{n\times n}$ が O($n^3$) で重くなる。 |
| **雑音同定**  | $Q,R$ のチューニングは依然として職人芸。拡張するとパラメータも増える。                       |

---

## まとめ

* **線形 KF** も状態拡張は可能だが “線形” の範囲に限られる。
* **EKF** は「非線形 + 状態増殖」に強く、**f/h を足して行列サイズを広げるだけ**で済むため “あとからモデルを追加できる” と評価される。
* **他のオブザーバ** では追加した途端に **ゲイン再設計や安定性証明** が必要になりがち。
* ただし EKF は **線形化誤差と計算量のペナルティ** を伴うため、モデル規模が大きい場合や強非線形では UKF, PF, MHE などの代替案も検討するのが実務上のポイントです。

> **実務例**
>
> * モータ駆動で「**磁束と巻線抵抗**」を同時推定
> * INS/GNSS で「**ジャイロバイアス**」を後付け状態化
> * 空調システムで「**熱容量係数**」をオンライン学習

これらはすべて EKF の“あとからモデルを追加”という利点を活かした好例です。
