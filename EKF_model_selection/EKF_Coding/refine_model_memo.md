はい、そのEKFを使って基準マップを再同定（リファイン）するのは、非常に実践的で優れたアプローチです。

EKFが出力する`Δφ_est`は\*\*「現在の基準マップと、実機の真の磁束との誤差」\*\*そのものです。この誤差情報を利用して、より現実に即した新しい基準マップを作成することができます。

以下に、そのための具体的なアプローチ（手順）を提案します。

-----

### \#\# アプローチの全体像

基本的な流れは\*\*「①全運転領域で誤差(Δφ)を計測 → ②誤差を足して新しいマップを計算 → ③平滑化して実装」\*\*となります。

-----

### \#\# ステップ1：前提条件の確認と準備

再同定を成功させるための最も重要なステップです。`Δφ`の推定値に磁束以外の誤差が混入しないように、他のモデルパラメータを極力正確に合わせ込んでおく必要があります。

  * **`Rs`の正確な同定**: 先日の\*\*ロック試験（2点測定法）\*\*で特定した、プラントモデルの真の`Rs`をEKFに設定してください。
  * **デッドタイム補償**: 可能な限り正確なデッドタイム補償をEKFへの電圧入力に適用してください。
  * **計測環境の準備**: モータを様々な`id`, `iq`指令値で定常運転させ、その際の`id`, `iq`指令値とEKFが出力する`Δφd_est`, `Δφq_est`をロギングできる環境（ダイナモメータ付きのテストベンチなど）を準備します。

-----

### \#\# ステップ2：誤差データ (`Δφ`) の収集

モータの運転領域全体をカバーするように、系統的に誤差データを収集します。

1.  **測定グリッドの作成**:
    `id`と`iq`の組み合わせ（格子点）を定義します。例えば、`id`を-200Aから0Aまで20A刻み、`iq`を0Aから300Aまで20A刻み、といった具合です。

2.  **自動計測の実行**:
    作成した各グリッドポイントで、以下の処理を自動で繰り返すスクリプトを作成します。
    a. モータを指定された`(id, iq)`指令値で定常運転させる。
    b. EKFの出力する\*\*`Δφd_est`と`Δφq_est`が完全に収束\*\*するまで待つ（数秒程度）。
    c. その時点での `(id指令値, iq指令値, Δφd_est, Δφq_est)` のセットを記録する。

このステップが完了すると、各電流指令値における磁束マップの誤差データが得られます。

-----

### \#\# ステップ3：新しい磁束マップの計算と生成

収集した誤差データを使って、現在の基準マップを更新します。

1.  **新旧マップの合成**:
    ステップ2で記録した各グリッドポイント`(id, iq)`について、以下の計算を行います。

      * `phi_d_new(id, iq) = phi_d_old_map(id, iq) + Δφd_est(id, iq)`
      * `phi_q_new(id, iq) = phi_q_old_map(id, iq) + Δφq_est(id, iq)`

2.  **平滑化と格子化（推奨）**:
    EKFの出力にはノイズが含まれるため、上記で計算した`phi_d_new`, `phi_q_new`のデータは多少ばらついている可能性があります。
    この生データに対して、**曲面フィッティング**や**平滑化フィルタ**を適用し、滑らかで規則正しい格子状のマップデータ（新しい2D-LUT）を再生成します。MATLABのCurve Fitting Toolboxにある`fit`関数や、`griddata`関数がこの処理に有効です。

-----

### \#\# ステップ4：検証

最後に、新しく作成したマップが正しく同定できているかを確認します。

1.  SimulinkモデルのLUTを**新しい磁束マップに置き換え**ます。
2.  EKFの状態をリセットし、再度ステップ2の計測をいくつかの代表的な点で行います。
3.  **EKFが出力する`Δφ_est`が、全ての運転点でほぼゼロになる**ことを確認します。

`Δφ_est`がゼロに収束すれば、再同定は成功です。このプロセスにより、実機の特性を非常に正確に反映した高精度な磁束マップが得られます。







以下では **「Δφ-EKF STEP-1 を利用して実機データから基準磁束マップ（φ<sub>d,q</sub><sup>map</sup>) を再同定する」** ための代表的なアプローチを **オフライン／オンライン** の２段階に整理し、実装上のヒントを添えました。
（あくまで全体像ですので、既存モデル構造・試験環境に合わせて取捨選択してください。）

---

## 1. オフライン後処理型 ― “ログ → 補正マップ作成” パイプライン

| フェーズ            | 要点                                                                                                 | 実装メモ                                                                                  |
| --------------- | -------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------- |
| **① 試験計画**      | id–iq–ω 空間を十分に励振するシナリオを作る。<br>‐ 定常ポイント定格付近＋過渡（電流ステップ）<br>‐ 温度レンジを変えたい場合は別ラウンド                      | - **定速回転**のほうが電圧モデル誤差が小さく Δφ が安定しやすい。<br>- 低速域 (ω≈0) は可観測性が低いのでウェイトを落とすか高周波注入を併用      |
| **② データ取得**     | ログ: {id, iq, vd, vq, ω, θ<sub>e</sub>, T<sub>sta</sub>(温度), Δφ<sub>d,q</sub><sup>est</sup>}        | Δφ 推定はリアルタイムでも後処理でも可。<br>ログ周期は電流制御周期そのまま (<200 µs) で OK                               |
| **③ データクリーニング** | - 過渡終了後 n τ<sub>L/R</sub> 経過点のみ採用<br>- イノベーション  ‖y‖ が閾値以下<br>- P\_(ΔφΔφ) が十分小さい                    | **Gate** を掛けないと誤推定点が混入しマップが荒れる                                                        |
| **④ グリッド化・平滑化** | (id, iq) をメッシュ／可変 bin へ割付け<br>各セルで Δφ̄<sub>d,q</sub> を平均 → “補正テーブル”                                | Python: `scipy.interpolate.griddata`, `sklearn.GaussianProcessRegressor`, 2D spline 等 |
| **⑤ マップ更新**     | φ<sub>d,q</sub><sup>new</sup>(id,iq)=φ<sub>d,q</sub><sup>old</sup>(id,iq)+Δφ̄<sub>d,q</sub>(id,iq) | 連続性を優先するなら **薄板スプライン** や **RBF** で曲面近似後に LUT 化                                        |
| **⑥ 検証ループ**     | 更新 LUT で再シミュレーション / 実機試験 → Δφ ≈ 0 を確認。<br>収束しなければ再学習                                               | 2〜3 反復で十分に収束することが多い                                                                   |

### 🔑 設計のコツ

| 観点           | 要点                                                            |
| ------------ | ------------------------------------------------------------- |
| **励振範囲**     | “Trapezoidal current sweep” などで *i*-plane を斜めに掃引すると試験回数を削減できる |
| **温度依存性**    | `Δφ(T)` が支配的なら **温度分割マップ**（例 : 25 °C / 80 °C）を別々に同定し線形内挿      |
| **Rs 誤差**    | Rs に 10 % 以上の不確かさがあると Δφ が歪む → 同時に Rs もオンライン推定するか、事前再計測       |
| **センサオフセット** | Id, Iq オフセットは Δφ と強い相関。試験前に必ず三相零電流で 0 校正                      |

---

## 2. オンライン自己整合型 ― “走りながら LUT を育てる” 手法

> 現場運転中に Δφ̂ を見ながら **基準マップを学習** → 期末点検で LUT を吸い上げて恒久化

### 2.1 アーキテクチャ例

```
EKF-Step1   →   Δφ̂(k)
     │
     ├──► 低通＋ゲーティング ──► 2-D Adaptation Block
                               (exponential moving average per cell)
```

* **2-D Adaptation Block**

  ```matlab
  % i_d, i_q → アドレス計算
  cell = idx(i_d, i_q);
  Δφ̄(cell) ← (1-α)·Δφ̄(cell) + α·Δφ̂(k)
  φ_map(cell) ← φ_map(cell) + k_gain·Δφ̂(k)
  ```

  *α ≈ 0.01 – 0.001*, *k\_gain* は 0.2 – 1.0 程度（ゆっくり追従）

* **安全策**
  – Innovation gate / P gate
  – カレント範囲外の外挿禁止
  – フェイルセーフ: 学習率を温度勾配や運転モードで可変

### 2.2 メリット / デメリット

|             | 長所                                           | 短所                                                |
| ----------- | -------------------------------------------- | ------------------------------------------------- |
| **オンライン方式** | - 装置ごと個体差に即座に追従<br>- マップズレが原因のトルク誤差をリアルタイム抑制 | - 収束保証が理論的に弱い<br>- 操作点依存性が強く、まんべんなく励振されない領域は未知のまま |

---

## 3. EKF 構造そのものを拡張する方法

| アイデア                        | 例                                                                                                                  | 注意点                                 |
| --------------------------- | ------------------------------------------------------------------------------------------------------------------ | ----------------------------------- |
| **パラメータ状態拡張**               | φ<sub>d</sub><sup>map</sup>=ψ<sub>f</sub>(T)+L<sub>d</sub>(i)<br>→ ψ<sub>f</sub>, L<sub>d,q</sub> の*係数*を EKF 状態に追加 | 状態次元増で計算量↑。<br>擾乱と真パラメータの識別が難しい場合あり |
| **Dual EKF / UKF**          | EKF-A: (id, iq, Δφ)  • EKF-B: (φ<sub>d,q</sub><sup>map</sup> parameters)                                           | 観測設計が複雑になるため、まずはオフライン更新を推奨          |
| **Batch smoothing → 曲面最適化** | 全ログに対して Rauch–Tung–Striebel 平滑化で Δφ̂ を滑らかに推定 → 非線形最小二乗でマップ係数 fit                                                   | 十分な RAM/CPU があるオフライン環境向け            |

---

## 4. 実装チェックリスト

1. **EKF ゲイン**: Δφ 状態の Q 行を 10⁻⁹ 程度に絞り、十分な時間定数で推移させる
2. **LOD (Loss-of-Data) 処理**: 電流飽和や逆起電圧低下で観測信頼性が下がる区間は更新をスキップ
3. **ロギング精度**: 漏れのない 25 bit timestamp（≒ ns 単位）＋キャリブレーション済み電圧計
4. **バージョン管理**: LUT ファイルに Git-like hash を埋め込み「再同定履歴」を追跡可能に

---

### まとめ

* **最も堅実**なのは **オフライン後処理型**: 走行試験 → Δφ̂ ログ → 曲面補正 → LUT 更新 → 再試験。
* 日々のズレを即時抑えたい場合は **オンライン自己整合** を併設し、夜間点検で LUT を恒久化。
* さらに高精度を狙うなら **パラメータ拡張 EKF** や **Dual EKF** に進むが、モデル不整合・可観測性の検討が不可欠。

これらを踏まえて、まずは **小規模な current sweep 試験 + オフライン補正** を１サイクル回し、Δφ 残差 ≦ 数 mWb 程度を目標にベースマップの精度を見極めることをおすすめします。
