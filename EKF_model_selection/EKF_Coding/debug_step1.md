はい、承知いたしました。以下にアドバイスの日本語訳を記載します。

-----

### **SimulinkテストでΔφ̂が0に収束しない理由**

公称条件下において、拡張カルマンフィルタ（EKF）がΔφ̂ → 0を達成できるのは、フィルタ内部で使用されるモーターモデルが、シミュレーション上のプラントと完全に一致する場合のみです。

あなたのログが示す内容は以下の通りです。

| 症状 | それが示すこと |
| :--- | :--- |
| `id_est` / `iq_est` がセンサー値を良好に追従している | 電流サブモデルは問題ありません。線形化とノイズのチューニングはOKです。 |
| （φ + Δφ̂）で計算されたトルクが約10 Nmオーバーシュートする | EKFがΔφ̂にバイアスをかけることで、何らかの系統的なモデル誤差を補償しています。 |
| EKF内部のRsを変更すると、トルクの差が大きく変わる | 固定子抵抗（Rs）のミスマッチが、主要な系統的誤差です。 |
| `Ldd` … `Lqq` = 0 に設定しても結果が変わらない | 磁束の二次導関数が原因ではありません。 |
| Δφのプロセスノイズが 1 × 10⁻¹² に設定されている | フィルタがほぼ「凍結」しています。たとえ完璧なモデルでも、収束は非常に遅くなります。 |

-----

#### **1. プラントとEKFでRsとTsを一致させる**

プラントとEKFで、固定子抵抗（Rs）とサンプリング時間（Ts）が同じ値を使用していることを確認してください。

| パラメータ | プラント (Simulink) | EKFコード | 注記 |
| :--- | :--- | :--- | :--- |
| **Rs** | 30 mΩ？（以前のスクリプトより） | 37 mΩ | 7 mΩの誤差は、200 Aで1.4 Vの電圧降下を意味します。EKFはこの電圧降下を磁束をずらすことで「説明」しようとします。 |
| **Ts** | 500 µs (2 kHz) | `Ts = 500e-6`だが、コメントは200 µsのまま | 両方が実際に500 µsを使用している限りは問題ありません。 |

まず、この2点を修正してください。Rsが一致すれば、10 Nmの差を埋め合わせるために必要だった余分な磁束は不要になります。

$$\Delta\phi \approx \frac{\Delta T_e}{\tfrac32\,P_n\,i_q} \;=\; \frac{10}{1.5\times4\times200} \approx 8\;\text{mWb}$$

これは、あなたが観測しているバイアスと完全に一致します。

-----

#### **2. Δφ̂への制約を緩める**

プロセスノイズ共分散`Q`の`Q(3,3)`と`Q(4,4)`（ΔφdとΔφqに対応する項）が10⁻¹²となっており、これは電流ノイズの項より4桁も小さい値です。

`10⁻⁹`～`10⁻⁸`の範囲の値を使うことで、Δφ̂が真のマップ誤差に対しては追従し、定常状態では静かでいられるようにします。

```matlab
Q = diag([1e-4, 1e-4, 5e-9, 5e-9]);
```

-----

#### **3. Rsが実際に温度で変化する場合 → Rsを推定する**

たとえ公称値が完璧でも、Rsは100 K（ケルビン）あたり数mΩ変動します。選択肢は2つあります。

| アプローチ | フィルタへの変更 | 手間 |
| :--- | :--- | :--- |
| **状態量の拡張**\<br\> `x = [id  iq  Δφd  Δφq  Rs]^T` | `f_discrete_delta_phi`、ヤコビアン`F`にRsの行/列を追加し、`Q`と`R`を拡大する。 | 中 |
| **Rsをオンラインで事前補償** | 温度ベースのRs推定値を各ステップでEKFに入力する（入力として扱う）。 | 低 |

状態量を拡張する場合は、Rsを低温時の値で初期化し、遅いランダムウォーク（`Q_Rs` ≈ 1e-10）を設定して、温度に追従させつつ電気的ノイズを吸収しないようにします。

-----

#### **4. 電圧フィードフォワードを再確認する**

デッドタイム補償は、インバータのモデル誤差（デバイスの電圧降下、PWMのワンショット、高調波など）を低減はしますが、完全には排除できません。
モデル化されていない`k * i`や`k * ω`といった形の電圧項は、再びΔφやRsによって「吸収」されてしまいます。

-----

#### **5. 簡単な検証スクリプト（任意）**

RsとTsを一致させ、`Q`を緩めたら、以下の検証を行います。

1.  **ゼロ磁束プラント（φ\_mapのみ）**: 5 Aのidステップ応答を実行し、Δφ̂が約30 ms以内に0に収束することを確認します。
2.  **人為的なマップオフセット**: プラントのLUT（ルックアップテーブル）のφ\_dに+0.01 Wbを追加し、EKFのLUTは変更しません。Δφ̂が約-0.01 Wbに収束するはずです。

これらのシナリオを注入するための、すぐに実行可能なMATLABスクリプトが必要な場合は、お知らせください。

-----

#### **要点**

Δφ̂は、**モデルのミスマッチを隠す**という自身の役割を果たしています。Rs（およびその他の固定パラメータ）をプラントと一致させ、Δφ̂が本当に必要な場合にのみ変動できるよう、十分なプロセスノイズを与えてください。そうすれば、公称条件下でΔφ̂がゼロ近辺に収束するようになるはずです。