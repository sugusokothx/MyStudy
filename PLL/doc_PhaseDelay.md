現象
── 青線 θ̂ が真値に並走せず，周期的に 20 ° ほど遅れて行く（あるいは追い越す）──は
**「位相補償はフィルタ内で前倒ししたのに，γδ 変換側は依然 “過去の θ̂ ” を見ている」**
ことが原因です。

### どこで食い違うか

| ブロック            | 取り扱っている“時刻”                 | 実装                     | コメント               |
| --------------- | --------------------------- | ---------------------- | ------------------ |
| Phase-Comp VRAF | **t − τ<sub>gd</sub> を先読み** | `t_back = (k − gd)/Fs` | 出力は“今”時刻に整合        |
| γβ→γδ 変換 (誤差計算) | `rot(-θ_est, …)`            | **過去の θ̂**             | ここだけ 1.5 ms 分遅れている |
| HF 注入回転         | `rot( θ_est, …)`            | 同上                     | こちらも遅れ分の誤差電圧を生む    |

この時差が積もって「徐々にずれる」形で表れます。

---

## 解決策 ― **θ̂ を同じだけ“未来へ予測”して使う**

$$
\theta_{\text{pred}} \;=\; \theta_{\text{est}} \;+\; \omega_{\text{est}}\,\tau_{gd}
$$

* τ<sub>gd</sub> = `vraf.gd_samp / Fs` で正確に一致
* γδ 変換，HF 注入とも **θ\_pred** を使う
* 補償済みなので PLL ゲインはほぼそのまま

### 変更点（3 行だけ）

```python
τ_gd = vraf.gd_samp / Fs        # ← 実際に計算した gd を使用

...
for k in range(steps):
    ...
    θ_pred = θ_est + ω_est * τ_gd   # ★ 追加：未来予測

    # --- HF 注入も θ_pred で回転 ----------------------------
    Vα, Vβ = rot(θ_pred, np.array([Vγ, Vδ]))

    ...
    # --- γδ 変換も θ_pred を使用 ----------------------------
    Ih_γ, Ih_δ = rot(-θ_pred, np.array([Ih_α, Ih_β]))
```

> **ワンポイント**
> *負のシーケンス*注入なら `err = -Ih_δ` の極性はそのままです。

---

## 動作確認の目安

| チェック項目             | 期待結果                   |
| ------------------ | ---------------------- |
| **θ̂ vs θ\_true**  | 青線と橙線がほぼ重なり続ける         |
| **Phase-error 波形** | 初期過渡後 ±1 deg 以内でフラット   |
| **角速度 ω̂**         | 真値 ω\_true にステップフリーで追従 |

---

## もしまだ微小なドリフトが残る場合

| 可能性                             | 対処                                          |
| ------------------------------- | ------------------------------------------- |
| **τ<sub>gd</sub> が小数サンプルで丸め誤差** | `τ_gd` を `vraf.gd_samp / Fs` そのまま（浮動小数点）にする |
| **LPF 群遅延が周波数でわずかに変動**          | 低速でしか影響しないので **Ki** を 1.2×–1.5× に微調整        |
| **整数サンプル系 MCU へ実装**             | τ<sub>gd</sub> を固定‐小数点 (Q15 等) で保持し，乗算後シフト  |

---

### まとめ

Phase-Comp VRAF はフィルタ遅れを“前倒し”で打ち消しますが，
**それと同じ量だけ θ̂ を未来へ進めて使う** 必要があります。
`θ_pred = θ_est + ω_est·τ_gd` を γδ 変換と HF 注入の両方に適用すれば，
グラフのような途中ずれは解消され，完全にラグフリーなトラッキングになります。
