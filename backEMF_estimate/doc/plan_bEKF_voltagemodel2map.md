### EKF design — **Voltage-equation model vs. Flux-map model**

| Item                                           | **Voltage-equation EKF**<br>(analytical *dq* voltage equations)                                                                                                                                                                                              | **Flux-map EKF**<br>(measured Ψ-map + Δφ‐scheme)                                                                                                                                                                                                                                                                                                             |
| ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **State vector x**                             | $[i_d,i_q,R_s,L_d,L_q,\psi_f]^{\!\top}$<br> (absolute currents & motor parameters)                                                                                                                                                                           | $[i_d,i_q,\,\Delta\! \phi_d,\,\Delta\! \phi_q,\,\Delta\!\psi_f,\,R_s]^{\!\top}$<br> (currents + “error flux” states)                                                                                                                                                                                                                                         |
| **Prediction f(x,u)**<br>(Euler-forward $T_s$) | $\displaystyle\begin{aligned} i_d^{+}&=i_d+\tfrac{T_s}{L_d}\bigl(v_d+\omega L_q i_q-R_s i_d\bigr)\\ i_q^{+}&=i_q+\tfrac{T_s}{L_q}\bigl(v_q-\omega(L_d i_d+\psi_f)-R_s i_q\bigr)\\ R_s^{+}&=R_s,\;L_d^{+}=L_d,\;L_q^{+}=L_q,\;\psi_f^{+}=\psi_f\end{aligned}$ | *step 1 — inverse LUT*<br> $i_d = \mathcal I_d(\phi_d,\phi_q)$, $i_q = \mathcal I_q(\phi_d,\phi_q)$<br>*step 2 — flux dynamics*<br> $\dot\phi_d = v_d-R_s i_d+\omega\phi_q$<br> $\dot\phi_q = v_q-R_s i_q-\omega\phi_d$<br> $\displaystyle\phi_d^{+}= \phi_d+T_s\dot\phi_d,\;\phi_q^{+}= \phi_q+T_s\dot\phi_q$<br> (Δ-states are updated through $\phi^{+}$) |
| **State-Jacobian F\_k = ∂f/∂x**                | *Closed form* (all terms linear in x)<br> e.g. $∂\dot i_d/∂i_q = \tfrac{T_s}{L_d}\, \omega L_q$.<br> Sparse 6×6; cheap to compute.                                                                                                                           | Contains LUT gradients: $∂i_d/∂\phi_d = (\partial\mathcal I_d/\partial\phi_d)$, etc.<br> ⇒ **non-linear, dense**, evaluated by bilinear-interp gradient or finite diff each step.                                                                                                                                                                            |
| **Process-noise Q\_k**                         | Small σ on currents; larger σ on slowly-varying parameters $R_s,ψ_f$.                                                                                                                                                                                        | Larger σ on Δ-flux states to absorb map mismatch; σ on $R_s$ as before.                                                                                                                                                                                                                                                                                      |
| **Measurement h(x)**                           | $h(x)=\begin{bmatrix}i_d\\i_q\end{bmatrix}$ (current sensors).                                                                                                                                                                                               | 同左 — currents still measured.                                                                                                                                                                                                                                                                                                                                |
| **Measurement-Jacobian H\_k**                  | Constant 2×6: $\begin{bmatrix}1&0&0&0&0&0\\0&1&0&0&0&0\end{bmatrix}$.                                                                                                                                                                                        | Same structure but columns permuted to match new state order (non-zero only in $i_d,i_q$ positions).                                                                                                                                                                                                                                                         |
| **Update step**                                | Standard: $K=P H^\top (H P H^\top+R)^{-1}$, etc.                                                                                                                                                                                                             | 同左 (表式不変)。                                                                                                                                                                                                                                                                                                                                                   |
| **Computational load**                         | O(1) analytic ops; suitable for high-rate DSP.                                                                                                                                                                                                               | Extra LUT lookup + gradient ⇒ heavier; often need numerical Jacobian.                                                                                                                                                                                                                                                                                        |
| **Model fidelity**                             | Ignores saturation / cross-coupling.                                                                                                                                                                                                                         | Reproduces measured saturation & MTPA/FW behaviour naturally.                                                                                                                                                                                                                                                                                                |

**Key take-aways**

* *Voltage-equation EKF* → 軽量・解析的。パラメータ推定と理論解析が楽。
* *Flux-map EKF* → 非線形現象をそのまま扱えるが、F\_k 計算と LUT 逆変換で計算量↑。

実装では **同じ update 式**を流用できるため、主な改造点は f(·) と F\_k のみです。
